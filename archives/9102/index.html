<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>Archives: 9102 | MechDancer Documentation</title>
  <meta name="description" content>
  <meta name="keywords" content>
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="https://raw.githubusercontent.com/MechDancer/mechdancer.github.io/master/css/images/favicon.png">
  <link rel="alternate" href="/Documentation/atom.xml" title="MechDancer Documentation">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="MechDancer Documentation">
<meta property="og:url" content="https://www.mechdancer.org/archives/9102/index.html">
<meta property="og:site_name" content="MechDancer Documentation">
<meta property="og:locale" content="en_US">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MechDancer Documentation">
    
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/Documentation/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>
</html>
<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class="wrapper">
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href="/Documentation/">
				MechDancer Documentation
			</a>
			<div class="menu">
				<ul class="h-list">
					
						<li>
							<a class="flat-box nav-home" href="/Documentation/">
								Home
							</a>
						</li>
					
						<li>
							<a class="flat-box nav-archives" href="/Documentation/archives">
								Archives
							</a>
						</li>
					
				</ul>
				<div class="underline"></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search">
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class="switcher h-list">
				
					<li class="s-search"><a href="javascript:void(0)"><span class="icon icon-search flat-box"></span></a></li>
				
				<li class="s-menu"><a href="javascript:void(0)"><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class="nav-sub container container--flex">
			<a class="logo" href="javascript:void(0)">
				Word of Forks
			</a>

			<ul class="switcher h-list">
				<li class="s-comment"><a href="javascript:void(0)"><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class="s-top"><a href="javascript:void(0)"><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class="s-toc"><a href="javascript:void(0)"><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/Documentation/" class="nav-home nav">
				Home
			</a>
		
			<a href="/Documentation/archives" class="nav-archives nav">
				Archives
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        
	
  <script>
    window.subData= { title:'Year : 9102'}
  </script>

<section class="post-list">
	
    <div class="post-wrapper">
      <!-- <article class="post reveal"> -->
<article class="post ">
  <section class="meta">
    
    <h2 class="title">
      <a href="/Documentation/dataflow/">
        Dataflow
      </a>
    </h2>
    
    <!-- <time>
      Jan 1, 9102
    </time> -->
		
  </section>
  <section class="article typo">
	  <h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p><em>dataflow</em> library provides components and tools to build data processing network, to help programmer build robust, concurrency-enabled applications easily. In other words, users do not need to manually manage task scheduling, even avoid all races under a premise of following certain design specifications and ensure the security of concurrent applications without mutex.</p>
<h2 id="Use-case"><a href="#Use-case" class="headerlink" title="Use case"></a>Use case</h2><p>Unlike traditional imperative programming, programmers who receive data flow ideas write programs by directly describing static data calculation sequences and data transfer relationships. Here is an example:</p>
 <figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking &#123;</span><br><span class="line">    <span class="comment">// initialize</span></span><br><span class="line">    <span class="keyword">val</span> source = broadcast&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line">    source - &#123; println(it) &#125;</span><br><span class="line">    source - &#123; <span class="number">2</span> * it &#125; - &#123; println(it) &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// using</span></span><br><span class="line">    source post <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// waiting</span></span><br><span class="line">    delay(<span class="number">100</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In this example, the initialization code section describes a network with 4 nodes:</p>
<ul>
<li>A source node, who transfers number to two child nodes simultaneously</li>
<li>A action node, print the number</li>
<li>A transform node, double the number</li>
<li>Another action node, print the doubled number</li>
</ul>
<p>In the code that follows, we post a number <em>1</em> to the source node. There will be a <em>1</em> and a <em>2</em> printout on the console. Normally 1 will appear before 2, but not absolute, because the dataflow library has <strong>parallelized</strong> these two actions.</p>
<p><img src="../images/network.png" alt="network"></p>
<p>By parallelization, we can make full use of the CPU’s computing performance, in the low-frequency multi-core architecture of the mobile phone CPU, the benefits brought by parallelization are particularly obvious. Building network construction directly helps programmers better organize logic and avoid the confusion caused by repeated multi-layered function calls and multiple control transferring. The disposable, unsupervised execution style avoids the complexity of process control, and the data flowing between nodes can be considered constant, so that arbitrarily modifying the data at the later stage will not pose a danger to the predecessor.</p>
<h2 id="Terminology"><a href="#Terminology" class="headerlink" title="Terminology"></a>Terminology</h2><p>There are some important concepts in the dataflow library:</p>
<ul>
<li><p><em>Node</em></p>
<p>Unlike the parallelized list operation supported by the standard libraries of many languages, dataflow provides coarse-grained parallelism, and nodes are atoms during the parallelization. The node is where the calculation takes place, and the data passing through the node is modified to change their value and type. In addition, unlike the imperative functions which do not manage the returned values at all, nodes also control the way that data is distributed backwards. </p>
<p>According to the behavior of the data entering the node, nodes can be divided into buffed and unbuffered. </p>
<p>According to the operation of data in the node, nodes can be divided into modified and unmodified.</p>
<p>According to the way the data leaves the node, nodes can be divided into cold, normal and broadcast.</p>
</li>
<li><p><em>Link</em></p>
<p>The links connect nodes and become channels for the data. The data passed through the link can be filtered and counted according to some rules.</p>
</li>
<li><p><em>Post</em></p>
<p>Data can be passed automatically between nodes in the network, but usually the node will only process the data from other nodes and pass it backwards instead of generating the data itself. The operation to send external data to the network to start processing is called “post”.</p>
</li>
</ul>
<h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><p>There are various ways to implement dataflow. The way we selected is to combine the responsive and producer consumer models, that is, the producer informs the consumer when the data is ready, and the consumer requests data from the producer when it is ready to process the data. The producer receives data from outside the network or other nodes, processes it, and then binds an id with the processed data, then informs the consumers it connected to with the id. The consumer immediately saves the id and uses the id to get corresponding data from the producer when it is ready to process it. If the data is still there (not consumed by other consumers and not discarded by the producer), the producer gives the data to the consumer. At which point the consumer becomes a producer, so the above steps will continue.</p>


    
    
    
  </section>
</article>
    </div>
  
    <div class="post-wrapper">
      <!-- <article class="post reveal"> -->
<article class="post ">
  <section class="meta">
    
    <h2 class="title">
      <a href="/Documentation/dependency/">
        Dependency
      </a>
    </h2>
    
    <!-- <time>
      Jan 1, 9102
    </time> -->
		
  </section>
  <section class="article typo">
	  <h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p><em>dependency</em> is an abstraction of <em>dynamic component lookup</em>. Through defining a series of interfaces, it standardizes the definition of weak coupling  for components (global resources or functional modules) depending each other in projects. Some operations are provided for developers to <strong>setup</strong> a component into <strong>dynamic scope</strong> concurrently, and identify component dependencies.</p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><h3 id="Definitions"><a href="#Definitions" class="headerlink" title="Definitions"></a>Definitions</h3><h4 id="Component"><a href="#Component" class="headerlink" title="Component"></a>Component</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">equals</span><span class="params">(other: <span class="type">Any</span>?)</span></span>: <span class="built_in">Boolean</span></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">hashCode</span><span class="params">()</span></span>: <span class="built_in">Int</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The core of this project, which classes should mark with, can be added to a <code>DynamicScope</code>. All dependencies are put in a hash set, thus developers can deal with conflict problems by overriding following two functions: <code>equals()</code> and <code>hashCode()</code>.</p>
<h4 id="Dependent"><a href="#Dependent" class="headerlink" title="Dependent"></a>Dependent</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Dependent</span> : <span class="type">Component &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">sync</span><span class="params">(dependency: <span class="type">Component</span>)</span></span>: <span class="built_in">Boolean</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Dependents are a kind of component that want to depends other components, i.e. find other components in the scope. <code>sync()</code> of dependents that haven’t found dependencies yet  will be called. It passes in a new dependency, dependencies can check whether this new dependency is what it’s waiting, or save dependency’s reference, get some information etc. Meanwhile, dependents should return if they are concerned about other components passed in later, which is commonly used for marking this dependent has already got all dependencies.</p>
<h4 id="Dynamic-scope"><a href="#Dynamic-scope" class="headerlink" title="Dynamic scope"></a>Dynamic scope</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicScope</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> dependents : MutableList&lt;...&gt; = ...</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">val</span> components : Set&lt;Component&gt; = ...</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">infix</span> <span class="function"><span class="keyword">fun</span> <span class="title">setup</span><span class="params">(component: <span class="type">Component</span>)</span></span>: <span class="built_in">Boolean</span> = ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Dynamic scope is an aggregate of components bearing relationships between components. When a new component is set up, <code>components</code> will be updated, and those  marked with <code>Dependent</code> will be notified of updating dependencies by calling theirs <code>sync()</code>. Developers can call <code>setup()</code> to add a component into this scope, which returns <code>false</code> if there is a conflict problem occurred.</p>
<h3 id="Abstract-components"><a href="#Abstract-components" class="headerlink" title="Abstract components"></a>Abstract components</h3><p>For easy of use, those two abstract class are defined:</p>
<ul>
<li><code>UniqueComponent</code></li>
<li><code>NamedComponent</code></li>
</ul>
<p>The reason why <code>UniqueComponent</code> is named so is that it has a unique <strong>type</strong> in the dynamic scope, and it uses its <code>Class</code> as the symbol while checking conflicts. Similar to <code>UniqueComponent</code>, <code>NamedComponent</code> has a unique <strong>name</strong> as the symbol. Since then, developers can provide a type to get a<code>UniqueComponent</code> or a name to get a <code>NamedComponent</code> in the dynamic scope.</p>
<h3 id="Dependency-manager"><a href="#Dependency-manager" class="headerlink" title="Dependency manager"></a>Dependency manager</h3><p>Once we have components mentioned above, providing parameters traversal components collection in dynamic scope for lookup some dependencies will be pretty common. Furthermore, developers should write a bunch of duplicated code in <code>sync()</code> if they want to use function provided by <code>Dependent</code>:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Apple</span> : <span class="type">UniqueComponent</span>&lt;<span class="type">Apple</span>&gt;</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Banana</span> : <span class="type">UniqueComponent</span>&lt;<span class="type">Banana</span>&gt;</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cherry</span> : <span class="type">UniqueComponent</span>&lt;<span class="type">Cherry</span>&gt;</span>()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FruitBasket</span> : <span class="type">UniqueComponent</span>&lt;<span class="type">FruitBasket</span>&gt;</span>(), Dependent &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> apple: Apple</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> banana: Banana</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> cherry: Cherry</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">sync</span><span class="params">(dependency: <span class="type">Component</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (dependency) &#123;</span><br><span class="line">            <span class="keyword">is</span> Apple -&gt; apple = dependency</span><br><span class="line">            <span class="keyword">is</span> Banana -&gt; banana = dependency</span><br><span class="line">            <span class="keyword">is</span> Cherry -&gt; cherry = dependency</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ::apple.isInitialized &amp;&amp; ::banana.isInitialized &amp;&amp; ::cherry.isInitialized</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>FruitBasket</code> depends on <code>Apple</code>, <code>Banana</code> and <code>Cherry</code>. <code>sync()</code> should be written as above to get dependencies in the scope. <code>DependencyManager</code> can help to optimize code like this:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Apple</span> : <span class="type">UniqueComponent</span>&lt;<span class="type">Apple</span>&gt;</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Banana</span> : <span class="type">UniqueComponent</span>&lt;<span class="type">Banana</span>&gt;</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cherry</span> : <span class="type">UniqueComponent</span>&lt;<span class="type">Cherry</span>&gt;</span>()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FruitBasket</span> : <span class="type">UniqueComponent</span>&lt;<span class="type">FruitBasket</span>&gt;</span>(), Dependent &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> dependencyManager = DependencyManager()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> apple: Apple <span class="keyword">by</span> dependencyManager.must()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> banana: Banana <span class="keyword">by</span> dependencyManager.must()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> cherry: Cherry <span class="keyword">by</span> dependencyManager.must()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">sync</span><span class="params">(dependency: <span class="type">Component</span>)</span></span>: <span class="built_in">Boolean</span> = 	</span><br><span class="line">    		dependencyManager.sync(dependency)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Moreover, <code>DependencyManager</code> provides powerful functions, please see <a href="#Use-cases">use cases</a> for details.</p>
<h2 id="Use-cases"><a href="#Use-cases" class="headerlink" title="Use cases"></a>Use cases</h2><ul>
<li><a href="https://github.com/MechDancer/framework/tree/master/remote" target="_blank" rel="noopener">remote</a></li>
<li><a href="https://github.com/StandaloneTC/host" target="_blank" rel="noopener">standalonetc</a></li>
</ul>


    
    
    
  </section>
</article>
    </div>
  
    <div class="post-wrapper">
      <!-- <article class="post reveal"> -->
<article class="post ">
  <section class="meta">
    
    <h2 class="title">
      <a href="/Documentation/mechdancerlib/">
        MechDancer Lib
      </a>
    </h2>
    
    <!-- <time>
      Jan 1, 9102
    </time> -->
		
  </section>
  <section class="article typo">
	  <h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p><em>mechdancerlib</em> is a FTC robot library written by Kotlin. It provides structurize device tree of the robot, including the encapsulation and dispatching, which make program easier to use.</p>
<h2 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h2><p>FTC Control System has kept out of the category of embedded development, thus it’s very friendly to people who is new to programming, however, the usability of it is not good enough. For example: </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">UnicornBaseOpMode</span> : <span class="type">OpMode</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> dumperArm: DCMotor</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> dumperPushRod: Servo</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> dustpan: Servo</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> collectorArm: DCMotor</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> collectorIntake: CRServo</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> expanderMotor: Motor</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> expanderLock: Servo</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> lifterTouch: RevTouchSensor</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> lifter: DCMotor</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">        lifterTouch = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        lifter = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        collectorArm = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        collectorIntake = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        expanderMotor = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        expanderLock = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        dustpan = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        dumperPushRod = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        dumperArm = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">loop</span><span class="params">()</span></span> &#123;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">stop</span><span class="params">()</span></span> &#123;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Pay attention to <code>init()</code>, all devices attached to this robot which defined in one class (although it’s abstract), should be bind through <code>hardwereMap</code>. Those devices are flattened in program, and it’s not easy to use or manage. Therefore, we defined a thing called <em>Structure</em>, we can distinctly layered the program the robot  through combining many <em>structures</em>. This is a part of our teleop:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">with(robot) &#123;</span><br><span class="line">    <span class="comment">//Chassis</span></span><br><span class="line">    chassis.descartes &#123;</span><br><span class="line">        x = master.leftStick.y</span><br><span class="line">        y = master.leftStick.x</span><br><span class="line">        w = <span class="number">0.7</span> * master.rightStick.x</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Helper</span></span><br><span class="line">    expander.expandState = <span class="keyword">when</span> &#123;</span><br><span class="line">        helper.up.bePressed()   -&gt; Expanding</span><br><span class="line">        helper.down.bePressed() -&gt; Shrinking</span><br><span class="line">        <span class="keyword">else</span>                    -&gt; Expander.ExpandState.Stop</span><br><span class="line">    &#125;</span><br><span class="line">    expander.lockState = <span class="keyword">when</span> &#123;</span><br><span class="line">        helper.left.isPressing()  -&gt; Lock</span><br><span class="line">        helper.right.isPressing() -&gt; Unlock</span><br><span class="line">        <span class="keyword">else</span>                      -&gt; expander.lockState</span><br><span class="line">    &#125;</span><br><span class="line">    collector.armState = <span class="keyword">when</span> &#123;</span><br><span class="line">        helper.leftStick.y &gt; <span class="number">0.5</span>  -&gt; Lifting</span><br><span class="line">        helper.leftStick.y &lt; -<span class="number">0.5</span> -&gt; Dropping</span><br><span class="line">        <span class="keyword">else</span>                      -&gt; Collector.ArmState.Stop</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Control details of devices are hidden, outer user should only focus on the whole robot control logic.</p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><h3 id="Terminology"><a href="#Terminology" class="headerlink" title="Terminology"></a>Terminology</h3><ul>
<li>A <em>structure</em> — is an specific definition of a robot part, like a rocker arm or a chassis. Once it is attached to robot as substructure, it will has a similar life-cycle.</li>
<li>A <em>monomeric structure</em> — is a kind of <em>structure</em> which does not have substructure. All real devices are <em>monomeric structures</em> because they can’t have childes.</li>
<li>A <em>composite structure</em> — a <em>structure</em> that have substructures. For example, a mecanum chassis is a <em>composite structure</em> which has four motors as substructure.</li>
<li><em>Robot</em> — is a unique <em>composite structure</em>, all structures are attached to it.</li>
</ul>
<h3 id="Structure-interface-and-classes"><a href="#Structure-interface-and-classes" class="headerlink" title="Structure interface and classes"></a>Structure interface and classes</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Structure</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">val</span> name: String</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span>: String</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This is a simple <em>structure</em> definition. It has a name, can be to string. <code>run()</code> function defines what this  <em>structure</em> should do when robot is running.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MonomericStructure</span></span>(<span class="keyword">override</span> <span class="keyword">val</span> name: String) : Structure</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CompositeStructure</span></span>(<span class="keyword">override</span> <span class="keyword">val</span> name: String) : Structure &#123;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">val</span> subStructures: List&lt;Structure&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The only difference between a <em>composite structure</em> and a <em>monomeric structure</em> is that a <em>composite structure</em> can have substructures attached to it.</p>
<h3 id="Device"><a href="#Device" class="headerlink" title="Device"></a>Device</h3><p>Device is a core of control system. Encapsulations done by FIRST are almost perfect, however, the only drawback is that the output and input data range are not unified. On the basis of correcting this, we create wrappers to let devices adapt this library. Furthermore, we high abstract the behavior of devices to make control more pure. We split devices which only perform output into <em>effector</em>, others into <em>sensor</em>.</p>
<h4 id="Effectors"><a href="#Effectors" class="headerlink" title="Effectors"></a>Effectors</h4><h5 id="Motor"><a href="#Motor" class="headerlink" title="Motor"></a>Motor</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Motor</span> : <span class="type">Structure &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> power: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> direction: Direction</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> lock: <span class="built_in">Boolean</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">Direction</span></span>(<span class="keyword">internal</span> <span class="keyword">val</span> sign: <span class="built_in">Int</span>) &#123;</span><br><span class="line">        FORWARD(+<span class="number">1</span>),</span><br><span class="line">        REVERSE(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>An user who control this motor should only notice the <code>power</code> and <code>direction</code> (ignore <code>lock</code> for the moment), implementing details is not important. The range of  <code>power</code> is from -1.0 to 1.0.</p>
<h5 id="Continuous-Servo"><a href="#Continuous-Servo" class="headerlink" title="Continuous Servo"></a>Continuous Servo</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ContinuousServo</span> : <span class="type">Structure &#123;</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> power: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pwmOutput: <span class="built_in">Boolean</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The only difference from motor is that it’s a pwm controlled device, whose output can be shutdown. The range of <code>power</code> is from -1.0 to 1.0.</p>
<h5 id="Servo"><a href="#Servo" class="headerlink" title="Servo"></a>Servo</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Servo</span> : <span class="type">Structure &#123;</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> position: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pwmOutput: <span class="built_in">Boolean</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It is a pwm device having a position output.  The range of <code>position</code> depends on device configuration. </p>
<blockquote>
<p>The unit of <code>position</code> is $rad$, which you have to specified in configuration.</p>
</blockquote>
<h4 id="Sensors"><a href="#Sensors" class="headerlink" title="Sensors"></a>Sensors</h4><h5 id="Encoder"><a href="#Encoder" class="headerlink" title="Encoder"></a>Encoder</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Encoder</span> : <span class="type">Structure &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> position: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> speed: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">reset</span><span class="params">(off: <span class="type">Double</span>)</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We separate the encoder from the motor. We believe that motors and encoders should be independent. This is a fly in the ointment in FIRST design. Certainly, they bind to a same <code>DCMotor</code> in low-level code. </p>
<blockquote>
<p>The unit of <code>position</code> is $rad$, <code>speed</code> is $rad/s​$.</p>
</blockquote>
<h5 id="Touch-Sensor"><a href="#Touch-Sensor" class="headerlink" title="Touch Sensor"></a>Touch Sensor</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">TouchSensor</span> : <span class="type">Structure &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> force: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">bePressed</span><span class="params">()</span></span>: <span class="built_in">Boolean</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">isPressing</span><span class="params">()</span></span>: <span class="built_in">Boolean</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">isReleasing</span><span class="params">()</span></span>: <span class="built_in">Boolean</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>bePressed()</code> returns the current state of button, <code>isPressing()</code> returns true when the first time the button be pressed, <code>isReleasing()</code> is similar to <code>isPressing()</code>. We process <code>Gamepad</code> in the same way, please see <a href="#Button">Gamepad</a>.</p>
<h5 id="Color-Sensor"><a href="#Color-Sensor" class="headerlink" title="Color Sensor"></a>Color Sensor</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ColorSensor</span> : <span class="type">Structure &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> colorData: ColorData</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> enableLed: <span class="built_in">Boolean</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">ColorData</span></span>(</span><br><span class="line">        <span class="keyword">val</span> red: <span class="built_in">Int</span>, </span><br><span class="line">        <span class="keyword">val</span> green: <span class="built_in">Int</span>, </span><br><span class="line">        <span class="keyword">val</span> blue: <span class="built_in">Int</span>, </span><br><span class="line">        <span class="keyword">val</span> alpha: <span class="built_in">Int</span>, </span><br><span class="line">        <span class="keyword">val</span> argb: <span class="built_in">Int</span>) </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Voltage-Sensor"><a href="#Voltage-Sensor" class="headerlink" title="Voltage Sensor"></a>Voltage Sensor</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">VoltageSensor</span> : <span class="type">Structure &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> voltage: <span class="built_in">Double</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Pre-cast-structures"><a href="#Pre-cast-structures" class="headerlink" title="Pre-cast structures"></a>Pre-cast structures</h3><p>We provides following common structures:</p>
<h4 id="Motor-with-encoder"><a href="#Motor-with-encoder" class="headerlink" title="Motor with encoder"></a>Motor with encoder</h4><p>As mentioned before, we divide the <code>Motor</code> and the <code>Encoder</code> into two parts according to their behavior. Although this is reasonable, in some cases it brings a lot of inconvenience. Therefore, a combination of motor and encoder is established. It is a <code>CompositeStructure</code>, have two substructures: a motor and a encoder. Through the combination of two devices, some new  behaviors come out. At the beginning of the design, we thought for a long time whether this class should be polymorphic. In other word, can <code>MotorWithEncoder</code> be <code>cast</code> to <code>Motor</code> or <code>Encoder</code>? i.e. have the behaviors of both of the above. That sounds right, but it’s a special case. Think about it: can a mechanical arm with only one motor be counted as a motor? Actually, it is the pure combination of the two devices, and it just has the behavior of the two that makes polymorphism reasonable. And actually that’s wrong. However for the sake of constraint its functions, we let it inherit class <code>Motor</code> and <code>Encoder</code>, let its substructures  work as delegates. Let’s see some details:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MotorWithEncoder</span> : <span class="type">Motor</span>, <span class="type">Encoder</span>, <span class="type">Structure &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> mode: Mode</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> targetSpeed: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> targetPosition: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> lock: <span class="built_in">Boolean</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">Mode</span> </span>&#123;</span><br><span class="line">        SPEED_CLOSE_LOOP, OPEN_LOOP, POSITION_CLOSE_LOOP,STOP</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>What behaviors mentioned above are that this combination has kinds of abilities to close-loop-control.</p>
<h4 id="Chassis"><a href="#Chassis" class="headerlink" title="Chassis"></a>Chassis</h4><p>Chassis plays an important part of robot, so we provide basic definition of this structure:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Chassis</span></span>(motorsConfig: Array&lt;Pair&lt;String, Motor.Direction&gt;&gt;, enable: <span class="built_in">Boolean</span>)</span><br><span class="line">    : CompositeStructure(<span class="string">"null_chassis"</span>), AutoCallable, SmartLogger &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> subStructures: List&lt;Motor&gt; =</span><br><span class="line">        motorsConfig.map &#123; MotorImpl(it.first, enable, it.second) &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">var</span> powers = DoubleArray(motorsConfig.size) &#123; .<span class="number">0</span> &#125;</span><br><span class="line">        <span class="keyword">get</span>() = field.standardizeBy(maxPower)</span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value.size != field.size)</span><br><span class="line">                warn(<span class="string">"Illegal size powers: <span class="subst">$&#123;value.size&#125;</span> ≠ <span class="subst">$&#123;field.size&#125;</span>"</span>)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                field = value</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> maxPower = <span class="number">1.0</span></span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value !<span class="keyword">in</span> -<span class="number">1.0</span>..<span class="number">1.0</span>)</span><br><span class="line">                warn(<span class="string">"Illegal max power: <span class="variable">$maxPower</span> ∉ [-1,1]"</span>)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                field = value</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Standardizes powers</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If the input power has a value greater than the input maximum constraint,</span></span><br><span class="line"><span class="comment">     * the maximum is adjusted to the constraint value,</span></span><br><span class="line"><span class="comment">     * and the other values are scaled down.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maxPower  maximum power constraint ∈ [-1,1]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> DoubleArray.<span class="title">standardizeBy</span><span class="params">(maxPower: <span class="type">Double</span>)</span></span> =</span><br><span class="line">        map(::abs).max()!!.let &#123;</span><br><span class="line">            <span class="keyword">if</span> (it &lt;= abs(maxPower))</span><br><span class="line">                maxPower.sign</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                maxPower / it</span><br><span class="line">        &#125;.let &#123;</span><br><span class="line">            DoubleArray(size) &#123; i -&gt;</span><br><span class="line">                <span class="keyword">this</span>[i] * it</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">        subStructures.forEachIndexed &#123; index: <span class="built_in">Int</span>, motor: Motor -&gt;</span><br><span class="line">            motor.power = powers[index]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As you’ve seen, chassis is a structure managing some motors assembly, which provide ability to process relationship between motors, including <strong>standardize</strong>. Therefore, is provided farther:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Omnidirectinal</span></span></span><br><span class="line">(motorsConfig: Array&lt;Pair&lt;String, Motor.Direction&gt;&gt;, enable: <span class="built_in">Boolean</span>)</span><br><span class="line">    : Chassis(motorsConfig, enable) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Descartes control parameters</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Descartes</span></span>(<span class="keyword">var</span> x: <span class="built_in">Double</span>,</span><br><span class="line">                         <span class="keyword">var</span> y: <span class="built_in">Double</span>,</span><br><span class="line">                         <span class="keyword">var</span> w: <span class="built_in">Double</span>) &#123;</span><br><span class="line">        <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">times</span><span class="params">(other: <span class="type">Descartes</span>)</span></span> =</span><br><span class="line">            Descartes(x * other.x, y * other.y, w * other.w)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Polar control parameters</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Polar</span></span>(<span class="keyword">var</span> rho: <span class="built_in">Double</span> = .<span class="number">0</span>,</span><br><span class="line">                     <span class="keyword">var</span> theta: <span class="built_in">Double</span> = .<span class="number">0</span>,</span><br><span class="line">                     <span class="keyword">var</span> omega: <span class="built_in">Double</span> = .<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">val</span> block: Descartes.() -&gt; <span class="built_in">Unit</span> = &#123;</span><br><span class="line">            x = rho * cos(theta)</span><br><span class="line">            y = rho * sin(theta)</span><br><span class="line">            w = omega</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tank control parameters</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">TankMode</span></span>(<span class="keyword">var</span> left: <span class="built_in">Double</span> = .<span class="number">0</span>,</span><br><span class="line">                        <span class="keyword">var</span> right: <span class="built_in">Double</span> = .<span class="number">0</span>,</span><br><span class="line">                        <span class="keyword">var</span> horizon: <span class="built_in">Double</span> = .<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">val</span> block: Descartes.() -&gt; <span class="built_in">Unit</span> = &#123;</span><br><span class="line">            x = left + right</span><br><span class="line">            y = horizon</span><br><span class="line">            w = left - right</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transforms descartes parameters to powers of each wheel.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> Descartes.<span class="title">transform</span><span class="params">()</span></span>: DoubleArray</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!advancedControlMode)</span><br><span class="line">            powers = (weights * descartes).transform()</span><br><span class="line">        <span class="keyword">super</span>.run()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Omnidirectinal is a kind of omni-directional mobile in <em>cartesian coordinate system</em>, there are three methods to control it, including <code>Descartes</code>, <code>TankMode</code>, and <code>Polar</code>. Notice that subclass need to declare motors and <code>transform</code> which describes how to drive this chassis. For convenience, drive way of mecanum chassis is built-in.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">Mecanum</span></span>(<span class="keyword">override</span> <span class="keyword">val</span> name: String = <span class="string">"chassis"</span>,</span><br><span class="line">                   enable: <span class="built_in">Boolean</span>,</span><br><span class="line">                   lfMotorDirection: Motor.Direction = Motor.Direction.REVERSE,</span><br><span class="line">                   lbMotorDirection: Motor.Direction = Motor.Direction.REVERSE,</span><br><span class="line">                   rfMotorDirection: Motor.Direction = Motor.Direction.FORWARD,</span><br><span class="line">                   rbMotorDirection: Motor.Direction = Motor.Direction.FORWARD,</span><br><span class="line">                   lfMotorName: String = <span class="string">"LF"</span>,</span><br><span class="line">                   lbMotorName: String = <span class="string">"LB"</span>,</span><br><span class="line">                   rfMotorName: String = <span class="string">"RF"</span>,</span><br><span class="line">                   rbMotorName: String = <span class="string">"RB"</span></span><br><span class="line">) : Omnidirectinal(arrayOf(</span><br><span class="line">    lfMotorName to lfMotorDirection, lbMotorName to lbMotorDirection,</span><br><span class="line">    rfMotorName to rfMotorDirection, rbMotorName to rbMotorDirection), enable) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> Descartes.<span class="title">transform</span><span class="params">()</span></span> =</span><br><span class="line">        doubleArrayOf(</span><br><span class="line">            +x + y - w,</span><br><span class="line">            +x - y - w,</span><br><span class="line">            +x - y + w,</span><br><span class="line">            +x + y + w)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Consequently, there is no need for you to write duplicated code anymore.</p>
<h3 id="Robot"><a href="#Robot" class="headerlink" title="Robot"></a>Robot</h3><p>Structure tree is the core of this library, every node of which is a structure. The foregoing implies that all devices have become <em>monomeric structure</em> which don’t have substructures. Robot is the root of this tree, middleware structures we defined are leaves  under the robot, devices are at the lowest nodes. Therefore, parent nodes just need to manage theirs sons, call <code>run()</code> of them. Because of the transitivity, robot is the parent of all structures.  Lets see an example:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DummyRobot</span> : <span class="type">Robot</span></span>(</span><br><span class="line">    <span class="string">"dummyRobot"</span>,</span><br><span class="line">    Mecanum(enable = <span class="literal">true</span>),</span><br><span class="line">    DummyArm(),</span><br><span class="line">    DeviceFactory.colorSensor(<span class="string">"colorSensor"</span>) &#123;</span><br><span class="line">        enable = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> colorSensor: ColorSensor</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> voltageSensor: VoltageSensor</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject(<span class="meta-string">"mecanumChassis"</span>)</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> chassis: Mecanum</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> dummyArm: DummyArm</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> armState: DummyArm.ArmState = DummyArm.ArmState.DOWN</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">        dummyArm.armState = armState</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Substructures’ instantiation are provided via the constructor of  Robot, and are used through <code>Inject</code>. You may think that it’s redundant that constructing a structure on your own but which can’t be a member of parent structure. In this case, substructures are created by your self, however, you can’t manage the life cycle of a structure frequently.</p>
<h3 id="Op-Mode"><a href="#Op-Mode" class="headerlink" title="Op Mode"></a>Op Mode</h3><p>Op mode is the entry point of whole robot control program. All thins we can do are based on op mode, and it has a <code>hardwareMap</code> providing us a easy why to control device interfaces.  Since we have our robot, we can write our op mode. Devices are bind to theirs corresponding structure wrappers in <code>init</code>, robot’s <code>run()</code> is called in <code>loop</code>. We do something quite import, so we ban the overriding of life cycle call back functions and provide new methods to let user to override:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseOpMode</span>&lt;<span class="type">T : Robot</span>&gt; : <span class="type">OpModeWithRobot</span>&lt;<span class="type">T</span>&gt;</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">val</span> robot: T = createRobot()</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">initTask</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">initLoopTask</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">startTask</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">loopTask</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">stopTask</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Notice at <code>robot</code>, <code>BaseOpMode</code> have a generic parameter <code>T:Robot</code>, which means robot instance can be constructed through its type. However, we have to ensure that robot class can’t be <code>abstract</code> and muse have a public constructor without parameters.</p>
<h3 id="Gamepad"><a href="#Gamepad" class="headerlink" title="Gamepad"></a>Gamepad</h3><p>Let’s see the definition in robot core:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Gamepad</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> left_stick_x = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> left_stick_y = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> right_stick_x = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> right_stick_y = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> dpad_up = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> dpad_down = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> dpad_left = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> dpad_right = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> a = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> b = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> x = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> y = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> start = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> back = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> left_bumper = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> right_bumper = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> left_stick_button = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> right_stick_button = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> left_trigger = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> right_trigger = <span class="number">0f</span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FIRST provides a convenient way to let us use gamepad directly, however, there are some little problems:</p>
<ul>
<li><p>Buttons and joysticks lie in one class flatly, <code>float</code> and <code>double</code> members mix together.</p>
</li>
<li><p>Joysticks have reversed vertical axis.</p>
</li>
<li><p>The way to realize pressing a button only one time (even keep pressing) to execute some actions  one time (e.g. when user press <code>x</code> button, a motor should start to run, etc.) really make people confused.</p>
</li>
</ul>
<p>Thus, we create few classes to reach better encapsulation.</p>
<h4 id="Button"><a href="#Button" class="headerlink" title="Button"></a>Button</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Button</span> : <span class="type">IGamePadComponent</span>&lt;<span class="type">Boolean</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> last = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">bePressed</span><span class="params">()</span></span> = raw</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">isPressing</span><span class="params">()</span></span> = !last &amp;&amp; bePressed()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">isReleasing</span><span class="params">()</span></span> = last &amp;&amp; !bePressed()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> raw: <span class="built_in">Boolean</span> = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            last = field</span><br><span class="line">            field = value</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As you see, <code>bePressed()</code> returns the current state of the button, while you keep pressing, <code>isPressing()</code> returns true only one time, <code>isReleasing()</code> returns true when you stop pressing.</p>
<h4 id="Stick"><a href="#Stick" class="headerlink" title="Stick"></a>Stick</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stick</span> : <span class="type">IGamePadComponent</span>&lt;<span class="type">DoubleArray</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> x <span class="keyword">get</span>() = raw[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> y <span class="keyword">get</span>() = raw[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> theta <span class="keyword">get</span>() = Math.atan2(y, x)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> radius <span class="keyword">get</span>() = sqrt(x * x + y * y)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> feel = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> diedArea = .<span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">mapExpression</span><span class="params">(x: <span class="type">Double</span>, f: <span class="type">Double</span>)</span></span> =</span><br><span class="line">        (f / ((<span class="number">1</span> - f) * (x + <span class="number">1</span>) + f) - f) / (f - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">nonlinearMap</span><span class="params">(x: <span class="type">Double</span>, feel: <span class="type">Double</span>, diedArea: <span class="type">Double</span>)</span></span> = <span class="keyword">when</span> &#123;</span><br><span class="line">        Math.abs(x) &lt; diedArea -&gt; .<span class="number">0</span></span><br><span class="line">        feel == <span class="number">1.0</span>            -&gt; x</span><br><span class="line">        x &lt; <span class="number">0</span>                  -&gt; mapExpression(x, feel)</span><br><span class="line">        <span class="keyword">else</span>                   -&gt; -mapExpression(-x, feel)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> raw: DoubleArray = doubleArrayOf(.<span class="number">0</span>, .<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            field = doubleArrayOf(</span><br><span class="line">                nonlinearMap(value[<span class="number">0</span>], feel, diedArea),</span><br><span class="line">                nonlinearMap(-value[<span class="number">1</span>], feel, diedArea))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We provides a <em>feel</em> represents tactile coefficient, hence, the stick data will be more smooth. Besides, we reversed back y axis.</p>
<h4 id="Trigger"><a href="#Trigger" class="headerlink" title="Trigger"></a>Trigger</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pressingThreshold = <span class="number">0.7</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">var</span> last = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">fun</span> <span class="title">bePressed</span><span class="params">()</span></span> = raw &gt; pressingThreshold</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">fun</span> <span class="title">isPressing</span><span class="params">()</span></span> = !last &amp;&amp; bePressed()</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">fun</span> <span class="title">isReleasing</span><span class="params">()</span></span> = last &amp;&amp; !bePressed()</span><br><span class="line"></span><br><span class="line"> <span class="keyword">override</span> <span class="keyword">var</span> raw: <span class="built_in">Double</span> = .<span class="number">0</span></span><br><span class="line">     <span class="keyword">set</span>(value) &#123;</span><br><span class="line">         last = field &gt; pressingThreshold</span><br><span class="line">         field = value</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>Usually, triggers are used as button is very common, so we add a <code>pressingThreshold</code> to make it become to a button.</p>
<h4 id="Overall"><a href="#Overall" class="headerlink" title="Overall"></a>Overall</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Gamepad</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> leftBumper = Button()</span><br><span class="line">    <span class="keyword">val</span> rightBumper = Button()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> a = Button()</span><br><span class="line">    <span class="keyword">val</span> b = Button()</span><br><span class="line">    <span class="keyword">val</span> x = Button()</span><br><span class="line">    <span class="keyword">val</span> y = Button()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> up = Button()</span><br><span class="line">    <span class="keyword">val</span> down = Button()</span><br><span class="line">    <span class="keyword">val</span> left = Button()</span><br><span class="line">    <span class="keyword">val</span> right = Button()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">val</span> leftStick = Stick()</span><br><span class="line">    <span class="keyword">val</span> rightStick = Stick()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> leftTrigger = Trigger()</span><br><span class="line">    <span class="keyword">val</span> rightTrigger = Trigger()</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h2><p>Let’s see a part of our robot:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dustpan</span> : <span class="type">AbstractStructure</span></span>(</span><br><span class="line">    <span class="string">"dustpan"</span>, &#123;</span><br><span class="line">    servo(<span class="string">"servo"</span>) &#123;</span><br><span class="line">        origin = .<span class="number">0</span></span><br><span class="line">        ending = PI</span><br><span class="line">        enable = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;), Resettable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> servo: Servo</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Volatile</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> isBusy = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> state: State <span class="keyword">by</span> Delegates.observable(State.Down) &#123; _, _, value -&gt;</span><br><span class="line">        servo.position = <span class="keyword">when</span> (value) &#123;</span><br><span class="line">            State.Up   -&gt; DUSTPAN_UP_RAD</span><br><span class="line">            State.Down -&gt; DUSTPAN_DOWN_RAD</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">dump</span><span class="params">(times: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isBusy) <span class="keyword">return</span></span><br><span class="line">        isBusy = <span class="literal">true</span></span><br><span class="line">        GlobalScope.launch &#123;</span><br><span class="line">            repeat(times) &#123;</span><br><span class="line">                state = State.Up</span><br><span class="line">                delay(DUSTPAN_RUNNING_DELAY)</span><br><span class="line">                state = State.Down</span><br><span class="line">                delay(DUSTPAN_RUNNING_DELAY)</span><br><span class="line">            &#125;</span><br><span class="line">            isBusy = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">        Up, Down</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">reset</span><span class="params">()</span></span> &#123;</span><br><span class="line">        state = State.Down</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span>: String = <span class="string">"<span class="subst">$&#123;javaClass.simpleName&#125;</span> | State: <span class="variable">$state</span>"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It is called <code>Dustpan</code>, which is driven by a 180° servo. According the design of library, dustpan is a structure, having device servo as its substructure. Then we abstract two state of this part — <code>Up</code> and <code>Down</code>, which represent two position of servo. For easy to modify parameters and reduce coupling, <code>DUSTPAN_UP_RAD</code> and <code>DUSTPAN_DOWN_RAD</code> lie in other file. Outside can change the value of variable <code>state</code> to change the real state of this robot part.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnicornRobot</span> : <span class="type">Robot</span></span>(</span><br><span class="line">    <span class="string">"unicorn_robot"</span>,</span><br><span class="line">    ...</span><br><span class="line">    Dustpan(),</span><br><span class="line">    ...</span><br><span class="line">) &#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> dustpan: Dustpan</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We have to add it as substructure of robot mentioned before. Since then, we can write a teleop to control it:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnicornRemote</span> : <span class="type">RemoteControlOpMode</span>&lt;<span class="type">UnicornRobot</span>&gt;</span>() &#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">loop</span><span class="params">(master: <span class="type">Gamepad</span>, helper: <span class="type">Gamepad</span>)</span></span>&#123;</span><br><span class="line">    	<span class="comment">//Master</span></span><br><span class="line">    	 <span class="keyword">if</span> (helper.y.isPressing()) </span><br><span class="line">         	robot.dustpan.dump(<span class="number">1</span>)</span><br><span class="line">         <span class="keyword">when</span> &#123;</span><br><span class="line">         	master.y.bePressed() -&gt; robot.dustpan.state=State.Up</span><br><span class="line">         	master.b.bePressed() -&gt; robot.dustpan.state=State.Down</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    
    
    
  </section>
</article>
    </div>
  
    <div class="post-wrapper">
      <!-- <article class="post reveal"> -->
<article class="post ">
  <section class="meta">
    
    <h2 class="title">
      <a href="/Documentation/slf4j-robotLog/">
        Slf4j-RobotLog
      </a>
    </h2>
    
    <!-- <time>
      Jan 1, 9102
    </time> -->
		
  </section>
  <section class="article typo">
	  <h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p><em>Slf4j-robotlog</em> is a binder for the <em>slf4j</em> logger interface version 1.7 for FTC robot programming. It can convert the output of some libraries through the <em>slf4j</em> log interface to <code>RobotLog</code> output.</p>
<h2 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h2><p>In the Java ecosystem, many library logs are used <em>slf4j</em> interface. But the logger provided in FTC programming is <code>RobotLog</code>, which also provides the ability to save the dump log to a file when the Op mode ends. However <em>slf4j</em> is just a specification of a logger without implementation. Common implementation in web programming is <em>log4j</em>, used by <em>slf4j</em> through a <em>binder</em>. <em>slf4j</em> will look for binders’implementation in the classpath at runtime. The binder uses <em>log4j</em> as the wrapper to implement the slf4j convention interface. Similarly, we use <code>RobotLog</code> as the wrapper to implement <em>slf4j</em> specification.</p>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><p>Just add this dependency to your project, all <em>slf4j</em> logs will perfectly output.</p>


    
    
    
  </section>
</article>
    </div>
  
    <div class="post-wrapper">
      <!-- <article class="post reveal"> -->
<article class="post ">
  <section class="meta">
    
    <h2 class="title">
      <a href="/Documentation/standalonetc/">
        Standalone TC
      </a>
    </h2>
    
    <!-- <time>
      Jan 1, 9102
    </time> -->
		
  </section>
  <section class="article typo">
	  <h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p><em>Standalone tc</em> is a simple implementation of the concept of responsive robot control system development. In robot programming, in most cases, the sensor is read in the loop and the current is output to the device. Such a program structure is not friendly to development because there must be coupling between instructions and controls. Reactive  system can avoid all problems, although the bottom layer is still looping through the driver. <em>Standalone tc</em> is divided into three parts: <em>host</em> - upper-level responsive dependencies, <em>slave</em> - lower-level controller communication, <em>protocol</em> - upper-lower and lower-level communication protocols. Among them <a href="https://www.mechdancer.org/Documentation/dataflow/"><em>dataflow</em></a> is responsible for the establishment of the upper layer responsive network. In addition, <em>host</em> provides tools for managing relationships between components from <a href="https://www.mechdancer.org/Documentation/dependency/"><em>dependency</em></a>.</p>
<p>Like its name <strong>Standalone</strong>, its purpose is to build a reactive robot control system that is not specific to a development platform. Therefore, when you change the platform, you only need to modify the implementation to the lower layer. We implemented this architecture first on FTC, so <em>slave</em> is the FTCRobotController App.</p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><h3 id="Terminology"><a href="#Terminology" class="headerlink" title="Terminology"></a>Terminology</h3><ul>
<li><em>Effector</em> — is a device that is only responsible for output, and its data node is <em>target</em>.</li>
<li><em>Sensor</em> — is a device that is only responsible for input, and its data node is <em>source</em>.</li>
<li><em>Robot</em> — is a <em>dynamic scope</em>, can load components.</li>
<li><em>Robot component</em> — is a special component with <code>init</code> and <code>stop</code> lifecycles.</li>
</ul>
<h3 id="Effector"><a href="#Effector" class="headerlink" title="Effector"></a>Effector</h3><p>The data node of all Effector types is <code>OutputDriver&lt;T&gt;</code>, which can be passed to the next node periodically when receiving data in the dataflow. Effector data nodes in the link should be the last end, and it will communicate to the network even when the robot starts. Let’s see most common effectors.</p>
<h4 id="Motor"><a href="#Motor" class="headerlink" title="Motor"></a>Motor</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Motor</span></span>(name: String, <span class="keyword">private</span> <span class="keyword">val</span> direction: Direction = Direction.FORWARD) :</span><br><span class="line">    NamedComponent&lt;Motor&gt;(name), Device, PowerOutput &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> power = OutputDriver&lt;<span class="built_in">Double</span>&gt; &#123; raw -&gt;</span><br><span class="line">        raw.checkedValue(-<span class="number">1.0</span>..<span class="number">1.0</span>)?.let &#123;</span><br><span class="line">            it * direction.sign</span><br><span class="line">        &#125; ?: logger.warning(<span class="string">"Invalid motor power value: <span class="variable">$raw</span>"</span>).run &#123; <span class="literal">null</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span>: String = <span class="string">"<span class="subst">$&#123;javaClass.simpleName&#125;</span>[<span class="variable">$name</span>]"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">Direction</span></span>(<span class="keyword">val</span> sign: <span class="built_in">Double</span>) &#123;</span><br><span class="line">        FORWARD(<span class="number">1.0</span>), REVERSED(-<span class="number">1.0</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">stop</span><span class="params">()</span></span> &#123;</span><br><span class="line">        power.close()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Motor has a data node <code>power</code>.</p>
<h4 id="Servo"><a href="#Servo" class="headerlink" title="Servo"></a>Servo</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Servo</span></span>(name: String, range: ClosedFloatingPointRange&lt;<span class="built_in">Double</span>&gt;) : NamedComponent&lt;Servo&gt;(name),</span><br><span class="line">    Device, PositionOutput, PwmOutput &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mapper = Lens(-<span class="number">1.0</span>, <span class="number">1.0</span>, range.start, range.endInclusive)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> position: OutputDriver&lt;<span class="built_in">Double</span>&gt; = OutputDriver &#123; raw -&gt;</span><br><span class="line">        raw.checkedValue(range)?.let &#123;</span><br><span class="line">            mapper(it)</span><br><span class="line">        &#125; ?: logger.warning(<span class="string">"Invalid servo position: <span class="variable">$raw</span>"</span>).run &#123; <span class="literal">null</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> pwmEnable: OutputDriver&lt;<span class="built_in">Boolean</span>&gt; = OutputDriver()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span>: String = <span class="string">"<span class="subst">$&#123;javaClass.simpleName&#125;</span>[<span class="variable">$name</span>]"</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Servo has two data nodes: <code>position</code> and <code>pwmEnable</code>.</p>
<h3 id="Sensor"><a href="#Sensor" class="headerlink" title="Sensor"></a>Sensor</h3><p>All Sensors are <em>source</em> nodes. When a sensor value is updated in network communication, data is placed in its data node. It should be the starting point in the link. Let’s look at the most common sensors.</p>
<h4 id="Encoder"><a href="#Encoder" class="headerlink" title="Encoder"></a>Encoder</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Encoder</span></span>(name: String, cpr: <span class="built_in">Double</span> = <span class="number">360.0</span>) : NamedComponent&lt;Encoder&gt;(name), Sensor&lt;EncoderData&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> value = AtomicReference(EncoderData(.<span class="number">0</span>, .<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> ratio = <span class="number">2</span> * PI / cpr</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Current position */</span></span><br><span class="line">    <span class="keyword">val</span> position <span class="keyword">get</span>() = value.<span class="keyword">get</span>().position</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Current speed */</span></span><br><span class="line">    <span class="keyword">val</span> speed <span class="keyword">get</span>() = value.<span class="keyword">get</span>().speed</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> updated: ISource&lt;EncoderData&gt; = broadcast()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">update</span><span class="params">(new: <span class="type">EncoderData</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> transformed = EncoderData(position * ratio, speed * ratio)</span><br><span class="line">        <span class="keyword">if</span> (value.getAndSet(transformed) != transformed)</span><br><span class="line">            updated tryPost transformed</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span>: String = <span class="string">"<span class="subst">$&#123;javaClass.simpleName&#125;</span>[<span class="variable">$name</span>]"</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It can be seen that in addition to the reactive flow of data, it also stores the last data for combined time operations.</p>
<h3 id="Robot"><a href="#Robot" class="headerlink" title="Robot"></a>Robot</h3><p>All devices are <em>component</em>, the robot is a <em>dynamic scope</em>, so the device can be <strong>setup</strong> to the bot. As mentioned in the <a href="https://www.mechdancer.org/Documentation/dependency/"><em>dependency</em></a> article, there may be some composite components in the robot that can rely on instances of the device. The robot initializes the <code>RobotComponent</code> in it when it initializes and configures the connection between the network communication and the dataflow.</p>
<h3 id="Use-case"><a href="#Use-case" class="headerlink" title="Use case"></a>Use case</h3><p>Let’s see teleop program:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> RemoteControl : RobotProgram&lt;UnicornRobot&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> master = robot.master</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> helper = robot.helper</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//Chassis</span></span><br><span class="line">        master.updated - &#123;</span><br><span class="line">            MecanumChassis.Descartes(</span><br><span class="line">                it.leftStickY,</span><br><span class="line">                it.leftStickX,</span><br><span class="line">                -it.rightStickX</span><br><span class="line">            )</span><br><span class="line">        &#125; - robot.chassis.descartesControl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Expander</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Helper up: Expanding/Stop</span></span><br><span class="line">        helper.up.pressing - &#123; Expander.State.Expanding &#125; - Expander.state</span><br><span class="line">        helper.up.releasing - &#123; Expander.State.Stop &#125; - Expander.state</span><br><span class="line">        <span class="comment">//Helper down: Shirking/Stop</span></span><br><span class="line">        helper.down.pressing - &#123; Expander.State.Shrinking &#125; - Expander.state</span><br><span class="line">        helper.down.releasing - &#123; Expander.State.Stop &#125; - Expander.state</span><br><span class="line">        <span class="comment">//Helper left and right: Lock/Unlock</span></span><br><span class="line">        helper.left.pressing - &#123; <span class="literal">true</span> &#125; - Expander.lock</span><br><span class="line">        helper.right.pressing - &#123; <span class="literal">false</span> &#125; - Expander.lock</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Collector</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Helper left stick: Lifting/Dropping/Stop</span></span><br><span class="line">        helper.leftStick.valueChanged - &#123;</span><br><span class="line">            <span class="keyword">when</span> &#123;</span><br><span class="line">                it.y &gt; <span class="number">0.5</span>  -&gt; Collector.ArmState.Lifting</span><br><span class="line">                it.y &lt; -<span class="number">0.5</span> -&gt; Collector.ArmState.Dropping</span><br><span class="line">                <span class="keyword">else</span>        -&gt; Collector.ArmState.Stop</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; - Collector.arm</span><br><span class="line">        <span class="comment">//Helper right trigger: Collecting/Stop</span></span><br><span class="line">        helper.rightTrigger.pressing - &#123; Collector.CollectorState.Collecting &#125; - Collector.core</span><br><span class="line">        helper.rightTrigger.releasing - &#123; Collector.CollectorState.Stop &#125; - Collector.core</span><br><span class="line">        <span class="comment">//Helper left bumper: Spiting/Stop</span></span><br><span class="line">        helper.leftBumper.pressing - &#123; Collector.CollectorState.Spiting &#125; - Collector.core</span><br><span class="line">        helper.leftBumper.releasing - &#123; Collector.CollectorState.Stop &#125; - Collector.core</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Dumper <span class="doctag">TODO:</span> Arguments</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Master right bumper: Pushes rod 2 times</span></span><br><span class="line">        master.rightBumper.pressing - &#123; <span class="number">2</span> &#125; - Dumper.pushRod</span><br><span class="line">        master.y.pressing - &#123; <span class="number">0.35</span> + <span class="keyword">if</span> (Dumper.inSadArea) <span class="number">0.2</span> <span class="keyword">else</span> .<span class="number">0</span> &#125; - Dumper.power</span><br><span class="line">        master.y.releasing - &#123; .<span class="number">0</span> &#125; - Dumper.power</span><br><span class="line">        master.a.pressing - &#123; <span class="number">0.5</span> + <span class="keyword">if</span> (Dumper.inSadArea) <span class="number">0.2</span> <span class="keyword">else</span> .<span class="number">0</span> &#125; - Dumper.power</span><br><span class="line">        master.b.releasing - &#123; .<span class="number">0</span> &#125; - Dumper.power</span><br><span class="line">        <span class="comment">//Helper y: Enable dumper lock</span></span><br><span class="line">        helper.y.pressing linkTo &#123; Dumper.lockEnable = !Dumper.lockEnable &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Lifter</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//When master left trigger is pressed, robot lands to ground</span></span><br><span class="line">        <span class="comment">//Presses right trigger to interrupt</span></span><br><span class="line">        master.leftTrigger.pressing - &#123; Lifter.State.Landing &#125; - Lifter.state</span><br><span class="line">        master.rightTrigger.pressing - &#123;</span><br><span class="line">            <span class="keyword">if</span> (Lifter.lastState == Lifter.State.Landing)</span><br><span class="line">                Lifter.State.Stop</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Lifter.State.Lifting</span><br><span class="line">        &#125; - Lifter.state</span><br><span class="line">        master.rightTrigger.releasing - &#123; Lifter.State.Stop &#125; - Lifter.state</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Dustpan</span></span><br><span class="line">        <span class="comment">//Master left bumper: dumps 1 time</span></span><br><span class="line">        master.leftBumper.pressing - &#123; <span class="number">1</span> &#125; - Dustpan.dump</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We should configure the link relationship when <code>init</code>. As shown in the snippet, when the gamepad1 value is updated, the remote sensing data is wrapped into a <em>chassis speed vector</em> and then flows into the <em>descartes controller</em> node of the chassis. When the button <code>up</code> of gampad2 is pressed, the state <code>Expanding</code> will flow into <code>state</code> of <code>Expander</code>. Because it is a remote control program, most of the links <em>source</em> are handles.</p>


    
    
    
  </section>
</article>
    </div>
  
    <div class="post-wrapper">
      <!-- <article class="post reveal"> -->
<article class="post ">
  <section class="meta">
    
    <h2 class="title">
      <a href="/Documentation/statemachine/">
        State machine
      </a>
    </h2>
    
    <!-- <time>
      Jan 1, 9102
    </time> -->
		
  </section>
  <section class="article typo">
	  <h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p><em>state machine</em> is a light-weight tool facilitate autonomous programming. It provides capability of collaborative working in single thread driven through loop. Thread safety is not supported.</p>
<h2 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h2><p>Typically, a op mode will be like this:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoOpMode</span> : <span class="type">BaseOpMode</span>&lt;<span class="type">UnicornRobot</span>&gt;</span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">initTask</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">loopTask</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">stopTask</span><span class="params">()</span></span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As for <code>BaseOpMode</code>, it’s a encryption of <code>OpMode</code>, which you can find in <a href="https://www.mechdancer.org/Documentation/mechdancerlib/">mechdancerlib</a>. Notice that the main logic we should write will be in <code>loopTask()</code>, which called circularly. For example, there is a simple requirement: robot moves forward for one second, then uses locator to move to a (5,5). Think about this process, it’s kind of a action chain, including delay and close-loop control. Those two are time-consuming procedures, as they ought to work in a loop. However, there is a problem that how to ensure that two actions can be run precisely in loop. Obviously, blocking the thread is not allowed, it’s the key that loop control structure should be converted to linear actions. Let’s see the implementation of the requirement mentioned above through linear state machine:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">demoLinearStateMachine</span><br><span class="line">    .add &#123;</span><br><span class="line">        robot.chassis.descartes &#123;</span><br><span class="line">            x = 1.0</span><br><span class="line">            y = .0</span><br><span class="line">            w = .0</span><br><span class="line">        &#125;</span><br><span class="line">        NEXT</span><br><span class="line">    &#125;</span><br><span class="line">    .add(Delay(1000))</span><br><span class="line">    .add(PIDMove(vector3DOf(0, 0, 0), .1, 0.2))</span><br></pre></td></tr></table></figure>
<p> What needs to be done next is calling the <code>invoke()</code> of the state machine in loop:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">loopTask</span><span class="params">()</span></span> &#123;</span><br><span class="line">    demoLinearStateMachine()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Actions are described as transfer of states via state machine, so that they can be run correctly in loop.</p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><h3 id="Primitives"><a href="#Primitives" class="headerlink" title="Primitives"></a>Primitives</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typealias</span> StateMember&lt;T&gt; = (() -&gt; T)</span><br><span class="line"></span><br><span class="line"><span class="keyword">typealias</span> StateMachine = StateMember&lt;<span class="built_in">Boolean</span>&gt;</span><br></pre></td></tr></table></figure>
<p><code>StateMember&lt;T&gt;</code> is a alias of <code>(() -&gt; T)</code>, which is lambda without parameter, return type <code>T</code>. In other words, arbitrary such lambda can be seen as a state. <code>StateMachine</code> is <code>StateMember&lt;Boolean&gt;</code>, a specific state, returning if this state machine is finished.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> FINISH = <span class="literal">true</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> CONTINUE = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> NEXT = <span class="literal">true</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> REPEAT = <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p><code>FINISH</code> and <code>CONTINUE</code> mark if state machine should switch state, <code>NEXT</code> and <code>REPEAT</code> mark if one state is finished. As you seen, all primitive definitions are <code>typealias</code> or <code>const val</code>, thus cost of running can be reduced.</p>
<h3 id="Operations"><a href="#Operations" class="headerlink" title="Operations"></a>Operations</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">infix fun &lt;T&gt; StateMember&lt;*&gt;.join(other: StateMember&lt;T&gt;): StateMember&lt;T&gt; = &#123; this(); other() &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> StateMachine.<span class="title">plus</span><span class="params">(other: <span class="type">StateMachine</span>)</span></span>: StateMachine = &#123;</span><br><span class="line">    <span class="keyword">val</span> a = <span class="keyword">this</span>()</span><br><span class="line">    <span class="keyword">val</span> b = other()</span><br><span class="line">    a || b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> StateMachine.<span class="title">times</span><span class="params">(other: <span class="type">StateMachine</span>)</span></span>: StateMachine = &#123;</span><br><span class="line">    <span class="keyword">val</span> a = <span class="keyword">this</span>()</span><br><span class="line">    <span class="keyword">val</span> b = other()</span><br><span class="line">    a &amp;&amp; b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> StateMember<span class="type">&lt;T&gt;</span>.<span class="title">run</span><span class="params">()</span></span>: T? = invoke()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> StateMachine.<span class="title">runToFinish</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (run() == CONTINUE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>join()</code> can combine two linear members into one linearly. Binary operators <code>+</code> and <code>*</code> are similar to operators between <code>Boolean</code>:<code>||</code> and <code>&amp;&amp;</code> correspondingly, which mean that when either <code>this</code> or <code>other</code> finish continue, when both <code>this</code> and <code>other</code> finish continue.  <code>runToFinish()</code> will block current thread until state machine’s invoke returning <code>true</code>.</p>
<h2 id="State-machines"><a href="#State-machines" class="headerlink" title="State machines"></a>State machines</h2><p>For easy to use, some preset state machine are provided:</p>
<ul>
<li><p><code>LinearStateMachine</code></p>
</li>
<li><p><code>LinearStateMachineWithWatchDog</code></p>
</li>
<li><code>RepeatingLinearStateMachine</code></li>
<li><code>StepStateMachine</code></li>
<li><code>StandardStateMachine</code></li>
<li><code>Delay</code></li>
</ul>
<p>For more information please see below.</p>
<h3 id="Linear-state-machines"><a href="#Linear-state-machines" class="headerlink" title="Linear state machines"></a>Linear state machines</h3><p>Linear state machine is a concept that running states sequentially. Even if there are few linear state machine definitions provided, they don’t have any superclass or interface contracting. They are named in this way due to the fact that they have similar behaviors.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">LinearStateMachine</span> : <span class="type">StateMachine &#123;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> states: Queue&lt;StateMember&lt;<span class="built_in">Boolean</span>&gt;&gt; = LinkedList&lt;StateMember&lt;<span class="built_in">Boolean</span>&gt;&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">add</span><span class="params">(state: <span class="type">StateMember</span>&lt;<span class="type">Boolean</span>&gt;)</span></span>: LinearStateMachine =</span><br><span class="line">        apply &#123; states.offer(state) &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> current = states.peek()</span><br><span class="line">        <span class="keyword">if</span> (current != <span class="literal">null</span> &amp;&amp; run(current) == NEXT) states.poll()</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (states.peek() == <span class="literal">null</span>) NEXT <span class="keyword">else</span> REPEAT</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Common linear state machine add state members into a internal queue simply, and poll state member from queue when state machine is running.</p>
 <figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">LinearStateMachineWithWatchDog</span> : <span class="type">StateMachine &#123;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> driver = LinearStateMachine()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">add</span><span class="params">(state: <span class="type">StateMember</span>&lt;<span class="type">Boolean</span>&gt;, timeout: <span class="type">Long</span>)</span></span>: LinearStateMachineWithWatchDog =</span><br><span class="line">        apply &#123;</span><br><span class="line">            driver.add(state + Delay(timeout))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">()</span></span> = driver()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The only difference from common linear state machine is that each state member has a time limit, which let state machine transfer when it’s timeout.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">RepeatingLinearStateMachine</span> : <span class="type">StateMachine &#123;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> states: MutableList&lt;StateMember&lt;<span class="built_in">Unit</span>&gt;&gt; = mutableListOf()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">add</span><span class="params">(state: <span class="type">StateMember</span>&lt;<span class="type">Unit</span>&gt;)</span></span>: RepeatingLinearStateMachine =</span><br><span class="line">        apply &#123; states.add(state) &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (states.isEmpty()) <span class="keyword">return</span> FINISH</span><br><span class="line">        states[index++]()</span><br><span class="line">        index %= states.size</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (<span class="number">0</span> == index) FINISH <span class="keyword">else</span> CONTINUE</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Repeating linear state machine is a special linear state machine, which do not discard states when that is finished, will run state members in loop.</p>
<h3 id="Step-state-machine"><a href="#Step-state-machine" class="headerlink" title="Step state machine"></a>Step state machine</h3><p>Step state machine doesn’t save state members, because current running state member will return state member to run later.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StepStateMachine</span></span>(<span class="keyword">private</span> <span class="keyword">var</span> current: StateMember&lt;StateMember&lt;*&gt;?&gt;?) : StateMachine &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="meta">@Suppress(<span class="meta-string">"UNCHECKED_CAST"</span>)</span></span><br><span class="line">        current = current?.invoke() <span class="keyword">as</span> StateMember&lt;StateMember&lt;*&gt;?&gt;?</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (current == <span class="literal">null</span>) FINISH <span class="keyword">else</span> CONTINUE</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If current state returns <code>null</code>, state machine will finish.</p>
<h3 id="Delay"><a href="#Delay" class="headerlink" title="Delay"></a>Delay</h3><p>Usually, delay plays an important role in control. Therefore, function delay are implemented through state machine as well.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Delay</span></span>(delay: <span class="built_in">Long</span>) : StateMachine &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> timer = MyTimer(delay)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> waiting: StateMember&lt;StateMember&lt;*&gt;?&gt; = &#123; <span class="literal">null</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        waiting = &#123; <span class="keyword">if</span> (timer.isFinished) <span class="literal">null</span> <span class="keyword">else</span> waiting &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> driver = StepStateMachine &#123; timer.start(); waiting &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">()</span></span> = driver()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Notice <code>driver</code>, the internal implementation of delay is a step state machine. <code>waiting</code> is a state member, returns <code>null</code> when time is up, itself otherwise. Actually this is a recursive lambda, step state machine uses such state member as mentioned before.</p>
<h3 id="Stellate"><a href="#Stellate" class="headerlink" title="Stellate"></a>Stellate</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StellateStateMachine</span>&lt;<span class="type">T</span>&gt;</span>(<span class="keyword">private</span> <span class="keyword">val</span> core: StateMember&lt;T&gt;) : StateMachine &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> states = HashMap&lt;T, StateMember&lt;<span class="built_in">Unit</span>&gt;&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">add</span><span class="params">(key: <span class="type">T</span>, state: <span class="type">StateMember</span>&lt;<span class="type">Unit</span>&gt;)</span></span>: StellateStateMachine&lt;T&gt; =</span><br><span class="line">        apply &#123; states[key] = state &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> currentKey = run(core)</span><br><span class="line">        <span class="keyword">if</span> (!states.containsKey(currentKey)) <span class="keyword">return</span> FINISH</span><br><span class="line">        states[currentKey]?.invoke()</span><br><span class="line">        <span class="keyword">return</span> CONTINUE</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Stellate state machine is unique because <code>core</code> will be run in every loop which returns the key to next common state. Common states can be add with a key using <code>add()</code>.</p>


    
    
    
  </section>
</article>
    </div>
  
</section>



      </div>
      <aside class='l_side'>
        
  <section class="m_widget about">

<img class="avatar waves-image" src="https://github.com/MechDancer/mechdancer.github.io/blob/master/css/images/mechdancer2.png?raw=true">

<div class="header">MechDancer</div>
<div class="content">
<div class="desc">The documentation of MechDancer Projects.</div>
</div>
</section>


  <section class="m_widget links">
<div class="header">Links</div>
<div class="content">
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="https://www.mechdancer.org">
            <div class="name">MechDancer Home</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="https://github.com/berberman">
            <div class="name">berberman Github</div>
        </a></li>
    
    </ul>
</div>
</section>

      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/mechdancer" class="social github" target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href="https://github.com/stkevintan/hexo-theme-material-flow" class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/node-waves/0.7.5/waves.min.js"></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/Documentation/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/Documentation/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/Documentation/js/search.js"></script>
<script src="/Documentation/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
