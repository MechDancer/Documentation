<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>MechDancer Lib | MechDancer Documentation</title>
  <meta name="description" content>
  <meta name="keywords" content>
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="https://raw.githubusercontent.com/MechDancer/mechdancer.github.io/master/css/images/favicon.png">
  <link rel="alternate" href="/Documentation/atom.xml" title="MechDancer Documentation">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Abstractmechdancerlib is a FTC robot library written by Kotlin. It provides structurize device tree of the robot, including the encapsulation and dispatching, which make program easier to use. Motivat">
<meta property="og:type" content="article">
<meta property="og:title" content="MechDancer Lib">
<meta property="og:url" content="https://www.mechdancer.org/mechdancerlib/index.html">
<meta property="og:site_name" content="MechDancer Documentation">
<meta property="og:description" content="Abstractmechdancerlib is a FTC robot library written by Kotlin. It provides structurize device tree of the robot, including the encapsulation and dispatching, which make program easier to use. Motivat">
<meta property="og:locale" content="en_US">
<meta property="og:updated_time" content="2019-04-14T07:00:00.491Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MechDancer Lib">
<meta name="twitter:description" content="Abstractmechdancerlib is a FTC robot library written by Kotlin. It provides structurize device tree of the robot, including the encapsulation and dispatching, which make program easier to use. Motivat">
    
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/Documentation/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>
</html>
<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class="wrapper">
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href="/Documentation/">
				MechDancer Documentation
			</a>
			<div class="menu">
				<ul class="h-list">
					
						<li>
							<a class="flat-box nav-home" href="/Documentation/">
								Home
							</a>
						</li>
					
						<li>
							<a class="flat-box nav-archives" href="/Documentation/archives">
								Archives
							</a>
						</li>
					
				</ul>
				<div class="underline"></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search">
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class="switcher h-list">
				
					<li class="s-search"><a href="javascript:void(0)"><span class="icon icon-search flat-box"></span></a></li>
				
				<li class="s-menu"><a href="javascript:void(0)"><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class="nav-sub container container--flex">
			<a class="logo" href="javascript:void(0)">
				Word of Forks
			</a>

			<ul class="switcher h-list">
				<li class="s-comment"><a href="javascript:void(0)"><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class="s-top"><a href="javascript:void(0)"><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class="s-toc"><a href="javascript:void(0)"><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/Documentation/" class="nav-home nav">
				Home
			</a>
		
			<a href="/Documentation/archives" class="nav-archives nav">
				Archives
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-mechdancerlib" class="post white-box article-type-post" itemscope itemprop="blogPost">
	<section class="meta">
	<h2 class="title">
  	<a href="/Documentation/mechdancerlib/">
    	MechDancer Lib
    </a>
  </h2>
	<!-- <time>
		Jan 1, 9102
	</time> -->
	
	</section>
	
		<section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Abstract"><span class="toc-number">1.</span> <span class="toc-text">Abstract</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Motivation"><span class="toc-number">2.</span> <span class="toc-text">Motivation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Overview"><span class="toc-number">3.</span> <span class="toc-text">Overview</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Terminology"><span class="toc-number">3.1.</span> <span class="toc-text">Terminology</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Structure-interface-and-classes"><span class="toc-number">3.2.</span> <span class="toc-text">Structure interface and classes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Device"><span class="toc-number">3.3.</span> <span class="toc-text">Device</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Effectors"><span class="toc-number">3.3.1.</span> <span class="toc-text">Effectors</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Motor"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">Motor</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Continuous-Servo"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">Continuous Servo</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Servo"><span class="toc-number">3.3.1.3.</span> <span class="toc-text">Servo</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Sensors"><span class="toc-number">3.3.2.</span> <span class="toc-text">Sensors</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Encoder"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">Encoder</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Touch-Sensor"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">Touch Sensor</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Color-Sensor"><span class="toc-number">3.3.2.3.</span> <span class="toc-text">Color Sensor</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Voltage-Sensor"><span class="toc-number">3.3.2.4.</span> <span class="toc-text">Voltage Sensor</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pre-cast-structures"><span class="toc-number">3.4.</span> <span class="toc-text">Pre-cast structures</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Motor-with-encoder"><span class="toc-number">3.4.1.</span> <span class="toc-text">Motor with encoder</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Chassis"><span class="toc-number">3.4.2.</span> <span class="toc-text">Chassis</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Robot"><span class="toc-number">3.5.</span> <span class="toc-text">Robot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Op-Mode"><span class="toc-number">3.6.</span> <span class="toc-text">Op Mode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gamepad"><span class="toc-number">3.7.</span> <span class="toc-text">Gamepad</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Button"><span class="toc-number">3.7.1.</span> <span class="toc-text">Button</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stick"><span class="toc-number">3.7.2.</span> <span class="toc-text">Stick</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Trigger"><span class="toc-number">3.7.3.</span> <span class="toc-text">Trigger</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Overall"><span class="toc-number">3.7.4.</span> <span class="toc-text">Overall</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sample"><span class="toc-number">4.</span> <span class="toc-text">Sample</span></a></li></ol></section>
	
	<section class="article typo">
  	<div class="article-entry" itemprop="articleBody">
			<h3 class="title">
			Repo: <a href="https://github.com/MechDancer/mechdancerlib">
						mechdancerlib
					</a>
				</h3>	
			<h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p><em>mechdancerlib</em> is a FTC robot library written by Kotlin. It provides structurize device tree of the robot, including the encapsulation and dispatching, which make program easier to use.</p>
<h2 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h2><p>FTC Control System has kept out of the category of embedded development, thus it’s very friendly to people who is new to programming, however, the usability of it is not good enough. For example: </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">UnicornBaseOpMode</span> : <span class="type">OpMode</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> dumperArm: DCMotor</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> dumperPushRod: Servo</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> dustpan: Servo</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> collectorArm: DCMotor</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> collectorIntake: CRServo</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> expanderMotor: Motor</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> expanderLock: Servo</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> lifterTouch: RevTouchSensor</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> lifter: DCMotor</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">        lifterTouch = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        lifter = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        collectorArm = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        collectorIntake = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        expanderMotor = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        expanderLock = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        dustpan = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        dumperPushRod = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">        dumperArm = hardwareMap.<span class="keyword">get</span>(...)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">loop</span><span class="params">()</span></span> &#123;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">stop</span><span class="params">()</span></span> &#123;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Pay attention to <code>init()</code>, all devices attached to this robot which defined in one class (although it’s abstract), should be bind through <code>hardwereMap</code>. Those devices are flattened in program, and it’s not easy to use or manage. Therefore, we defined a thing called <em>Structure</em>, we can distinctly layered the program the robot  through combining many <em>structures</em>. This is a part of our teleop:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">with(robot) &#123;</span><br><span class="line">    <span class="comment">//Chassis</span></span><br><span class="line">    chassis.descartes &#123;</span><br><span class="line">        x = master.leftStick.y</span><br><span class="line">        y = master.leftStick.x</span><br><span class="line">        w = <span class="number">0.7</span> * master.rightStick.x</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Helper</span></span><br><span class="line">    expander.expandState = <span class="keyword">when</span> &#123;</span><br><span class="line">        helper.up.bePressed()   -&gt; Expanding</span><br><span class="line">        helper.down.bePressed() -&gt; Shrinking</span><br><span class="line">        <span class="keyword">else</span>                    -&gt; Expander.ExpandState.Stop</span><br><span class="line">    &#125;</span><br><span class="line">    expander.lockState = <span class="keyword">when</span> &#123;</span><br><span class="line">        helper.left.isPressing()  -&gt; Lock</span><br><span class="line">        helper.right.isPressing() -&gt; Unlock</span><br><span class="line">        <span class="keyword">else</span>                      -&gt; expander.lockState</span><br><span class="line">    &#125;</span><br><span class="line">    collector.armState = <span class="keyword">when</span> &#123;</span><br><span class="line">        helper.leftStick.y &gt; <span class="number">0.5</span>  -&gt; Lifting</span><br><span class="line">        helper.leftStick.y &lt; -<span class="number">0.5</span> -&gt; Dropping</span><br><span class="line">        <span class="keyword">else</span>                      -&gt; Collector.ArmState.Stop</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Control details of devices are hidden, outer user should only focus on the whole robot control logic.</p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><h3 id="Terminology"><a href="#Terminology" class="headerlink" title="Terminology"></a>Terminology</h3><ul>
<li>A <em>structure</em> — is an specific definition of a robot part, like a rocker arm or a chassis. Once it is attached to robot as substructure, it will has a similar life-cycle.</li>
<li>A <em>monomeric structure</em> — is a kind of <em>structure</em> which does not have substructure. All real devices are <em>monomeric structures</em> because they can’t have childes.</li>
<li>A <em>composite structure</em> — a <em>structure</em> that have substructures. For example, a mecanum chassis is a <em>composite structure</em> which has four motors as substructure.</li>
<li><em>Robot</em> — is a unique <em>composite structure</em>, all structures are attached to it.</li>
</ul>
<h3 id="Structure-interface-and-classes"><a href="#Structure-interface-and-classes" class="headerlink" title="Structure interface and classes"></a>Structure interface and classes</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Structure</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">val</span> name: String</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span>: String</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This is a simple <em>structure</em> definition. It has a name, can be to string. <code>run()</code> function defines what this  <em>structure</em> should do when robot is running.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MonomericStructure</span></span>(<span class="keyword">override</span> <span class="keyword">val</span> name: String) : Structure</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CompositeStructure</span></span>(<span class="keyword">override</span> <span class="keyword">val</span> name: String) : Structure &#123;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">val</span> subStructures: List&lt;Structure&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The only difference between a <em>composite structure</em> and a <em>monomeric structure</em> is that a <em>composite structure</em> can have substructures attached to it.</p>
<h3 id="Device"><a href="#Device" class="headerlink" title="Device"></a>Device</h3><p>Device is a core of control system. Encapsulations done by FIRST are almost perfect, however, the only drawback is that the output and input data range are not unified. On the basis of correcting this, we create wrappers to let devices adapt this library. Furthermore, we high abstract the behavior of devices to make control more pure. We split devices which only perform output into <em>effector</em>, others into <em>sensor</em>.</p>
<h4 id="Effectors"><a href="#Effectors" class="headerlink" title="Effectors"></a>Effectors</h4><h5 id="Motor"><a href="#Motor" class="headerlink" title="Motor"></a>Motor</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Motor</span> : <span class="type">Structure &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> power: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> direction: Direction</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> lock: <span class="built_in">Boolean</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">Direction</span></span>(<span class="keyword">internal</span> <span class="keyword">val</span> sign: <span class="built_in">Int</span>) &#123;</span><br><span class="line">        FORWARD(+<span class="number">1</span>),</span><br><span class="line">        REVERSE(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>An user who control this motor should only notice the <code>power</code> and <code>direction</code> (ignore <code>lock</code> for the moment), implementing details is not important. The range of  <code>power</code> is from -1.0 to 1.0.</p>
<h5 id="Continuous-Servo"><a href="#Continuous-Servo" class="headerlink" title="Continuous Servo"></a>Continuous Servo</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ContinuousServo</span> : <span class="type">Structure &#123;</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> power: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pwmOutput: <span class="built_in">Boolean</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The only difference from motor is that it’s a pwm controlled device, whose output can be shutdown. The range of <code>power</code> is from -1.0 to 1.0.</p>
<h5 id="Servo"><a href="#Servo" class="headerlink" title="Servo"></a>Servo</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Servo</span> : <span class="type">Structure &#123;</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> position: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pwmOutput: <span class="built_in">Boolean</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It is a pwm device having a position output.  The range of <code>position</code> depends on device configuration. </p>
<blockquote>
<p>The unit of <code>position</code> is $rad$, which you have to specified in configuration.</p>
</blockquote>
<h4 id="Sensors"><a href="#Sensors" class="headerlink" title="Sensors"></a>Sensors</h4><h5 id="Encoder"><a href="#Encoder" class="headerlink" title="Encoder"></a>Encoder</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Encoder</span> : <span class="type">Structure &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> position: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> speed: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">reset</span><span class="params">(off: <span class="type">Double</span>)</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We separate the encoder from the motor. We believe that motors and encoders should be independent. This is a fly in the ointment in FIRST design. Certainly, they bind to a same <code>DCMotor</code> in low-level code. </p>
<blockquote>
<p>The unit of <code>position</code> is $rad$, <code>speed</code> is $rad/s​$.</p>
</blockquote>
<h5 id="Touch-Sensor"><a href="#Touch-Sensor" class="headerlink" title="Touch Sensor"></a>Touch Sensor</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">TouchSensor</span> : <span class="type">Structure &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> force: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">bePressed</span><span class="params">()</span></span>: <span class="built_in">Boolean</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">isPressing</span><span class="params">()</span></span>: <span class="built_in">Boolean</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">isReleasing</span><span class="params">()</span></span>: <span class="built_in">Boolean</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>bePressed()</code> returns the current state of button, <code>isPressing()</code> returns true when the first time the button be pressed, <code>isReleasing()</code> is similar to <code>isPressing()</code>. We process <code>Gamepad</code> in the same way, please see <a href="#Button">Gamepad</a>.</p>
<h5 id="Color-Sensor"><a href="#Color-Sensor" class="headerlink" title="Color Sensor"></a>Color Sensor</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ColorSensor</span> : <span class="type">Structure &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> colorData: ColorData</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> enableLed: <span class="built_in">Boolean</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">ColorData</span></span>(</span><br><span class="line">        <span class="keyword">val</span> red: <span class="built_in">Int</span>, </span><br><span class="line">        <span class="keyword">val</span> green: <span class="built_in">Int</span>, </span><br><span class="line">        <span class="keyword">val</span> blue: <span class="built_in">Int</span>, </span><br><span class="line">        <span class="keyword">val</span> alpha: <span class="built_in">Int</span>, </span><br><span class="line">        <span class="keyword">val</span> argb: <span class="built_in">Int</span>) </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Voltage-Sensor"><a href="#Voltage-Sensor" class="headerlink" title="Voltage Sensor"></a>Voltage Sensor</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">VoltageSensor</span> : <span class="type">Structure &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> voltage: <span class="built_in">Double</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Pre-cast-structures"><a href="#Pre-cast-structures" class="headerlink" title="Pre-cast structures"></a>Pre-cast structures</h3><p>We provides following common structures:</p>
<h4 id="Motor-with-encoder"><a href="#Motor-with-encoder" class="headerlink" title="Motor with encoder"></a>Motor with encoder</h4><p>As mentioned before, we divide the <code>Motor</code> and the <code>Encoder</code> into two parts according to their behavior. Although this is reasonable, in some cases it brings a lot of inconvenience. Therefore, a combination of motor and encoder is established. It is a <code>CompositeStructure</code>, have two substructures: a motor and a encoder. Through the combination of two devices, some new  behaviors come out. At the beginning of the design, we thought for a long time whether this class should be polymorphic. In other word, can <code>MotorWithEncoder</code> be <code>cast</code> to <code>Motor</code> or <code>Encoder</code>? i.e. have the behaviors of both of the above. That sounds right, but it’s a special case. Think about it: can a mechanical arm with only one motor be counted as a motor? Actually, it is the pure combination of the two devices, and it just has the behavior of the two that makes polymorphism reasonable. And actually that’s wrong. However for the sake of constraint its functions, we let it inherit class <code>Motor</code> and <code>Encoder</code>, let its substructures  work as delegates. Let’s see some details:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MotorWithEncoder</span> : <span class="type">Motor</span>, <span class="type">Encoder</span>, <span class="type">Structure &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> mode: Mode</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> targetSpeed: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> targetPosition: <span class="built_in">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> lock: <span class="built_in">Boolean</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">Mode</span> </span>&#123;</span><br><span class="line">        SPEED_CLOSE_LOOP, OPEN_LOOP, POSITION_CLOSE_LOOP,STOP</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>What behaviors mentioned above are that this combination has kinds of abilities to close-loop-control.</p>
<h4 id="Chassis"><a href="#Chassis" class="headerlink" title="Chassis"></a>Chassis</h4><p>Chassis plays an important part of robot, so we provide basic definition of this structure:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Chassis</span></span>(motorsConfig: Array&lt;Pair&lt;String, Motor.Direction&gt;&gt;, enable: <span class="built_in">Boolean</span>)</span><br><span class="line">    : CompositeStructure(<span class="string">"null_chassis"</span>), AutoCallable, SmartLogger &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> subStructures: List&lt;Motor&gt; =</span><br><span class="line">        motorsConfig.map &#123; MotorImpl(it.first, enable, it.second) &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">var</span> powers = DoubleArray(motorsConfig.size) &#123; .<span class="number">0</span> &#125;</span><br><span class="line">        <span class="keyword">get</span>() = field.standardizeBy(maxPower)</span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value.size != field.size)</span><br><span class="line">                warn(<span class="string">"Illegal size powers: <span class="subst">$&#123;value.size&#125;</span> ≠ <span class="subst">$&#123;field.size&#125;</span>"</span>)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                field = value</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> maxPower = <span class="number">1.0</span></span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value !<span class="keyword">in</span> -<span class="number">1.0</span>..<span class="number">1.0</span>)</span><br><span class="line">                warn(<span class="string">"Illegal max power: <span class="variable">$maxPower</span> ∉ [-1,1]"</span>)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                field = value</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Standardizes powers</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If the input power has a value greater than the input maximum constraint,</span></span><br><span class="line"><span class="comment">     * the maximum is adjusted to the constraint value,</span></span><br><span class="line"><span class="comment">     * and the other values are scaled down.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maxPower  maximum power constraint ∈ [-1,1]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> DoubleArray.<span class="title">standardizeBy</span><span class="params">(maxPower: <span class="type">Double</span>)</span></span> =</span><br><span class="line">        map(::abs).max()!!.let &#123;</span><br><span class="line">            <span class="keyword">if</span> (it &lt;= abs(maxPower))</span><br><span class="line">                maxPower.sign</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                maxPower / it</span><br><span class="line">        &#125;.let &#123;</span><br><span class="line">            DoubleArray(size) &#123; i -&gt;</span><br><span class="line">                <span class="keyword">this</span>[i] * it</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">        subStructures.forEachIndexed &#123; index: <span class="built_in">Int</span>, motor: Motor -&gt;</span><br><span class="line">            motor.power = powers[index]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As you’ve seen, chassis is a structure managing some motors assembly, which provide ability to process relationship between motors, including <strong>standardize</strong>. Therefore, is provided farther:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Omnidirectinal</span></span></span><br><span class="line">(motorsConfig: Array&lt;Pair&lt;String, Motor.Direction&gt;&gt;, enable: <span class="built_in">Boolean</span>)</span><br><span class="line">    : Chassis(motorsConfig, enable) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Descartes control parameters</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Descartes</span></span>(<span class="keyword">var</span> x: <span class="built_in">Double</span>,</span><br><span class="line">                         <span class="keyword">var</span> y: <span class="built_in">Double</span>,</span><br><span class="line">                         <span class="keyword">var</span> w: <span class="built_in">Double</span>) &#123;</span><br><span class="line">        <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">times</span><span class="params">(other: <span class="type">Descartes</span>)</span></span> =</span><br><span class="line">            Descartes(x * other.x, y * other.y, w * other.w)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Polar control parameters</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Polar</span></span>(<span class="keyword">var</span> rho: <span class="built_in">Double</span> = .<span class="number">0</span>,</span><br><span class="line">                     <span class="keyword">var</span> theta: <span class="built_in">Double</span> = .<span class="number">0</span>,</span><br><span class="line">                     <span class="keyword">var</span> omega: <span class="built_in">Double</span> = .<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">val</span> block: Descartes.() -&gt; <span class="built_in">Unit</span> = &#123;</span><br><span class="line">            x = rho * cos(theta)</span><br><span class="line">            y = rho * sin(theta)</span><br><span class="line">            w = omega</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tank control parameters</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">TankMode</span></span>(<span class="keyword">var</span> left: <span class="built_in">Double</span> = .<span class="number">0</span>,</span><br><span class="line">                        <span class="keyword">var</span> right: <span class="built_in">Double</span> = .<span class="number">0</span>,</span><br><span class="line">                        <span class="keyword">var</span> horizon: <span class="built_in">Double</span> = .<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">val</span> block: Descartes.() -&gt; <span class="built_in">Unit</span> = &#123;</span><br><span class="line">            x = left + right</span><br><span class="line">            y = horizon</span><br><span class="line">            w = left - right</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transforms descartes parameters to powers of each wheel.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> Descartes.<span class="title">transform</span><span class="params">()</span></span>: DoubleArray</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!advancedControlMode)</span><br><span class="line">            powers = (weights * descartes).transform()</span><br><span class="line">        <span class="keyword">super</span>.run()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Omnidirectinal is a kind of omni-directional mobile in <em>cartesian coordinate system</em>, there are three methods to control it, including <code>Descartes</code>, <code>TankMode</code>, and <code>Polar</code>. Notice that subclass need to declare motors and <code>transform</code> which describes how to drive this chassis. For convenience, drive way of mecanum chassis is built-in.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">Mecanum</span></span>(<span class="keyword">override</span> <span class="keyword">val</span> name: String = <span class="string">"chassis"</span>,</span><br><span class="line">                   enable: <span class="built_in">Boolean</span>,</span><br><span class="line">                   lfMotorDirection: Motor.Direction = Motor.Direction.REVERSE,</span><br><span class="line">                   lbMotorDirection: Motor.Direction = Motor.Direction.REVERSE,</span><br><span class="line">                   rfMotorDirection: Motor.Direction = Motor.Direction.FORWARD,</span><br><span class="line">                   rbMotorDirection: Motor.Direction = Motor.Direction.FORWARD,</span><br><span class="line">                   lfMotorName: String = <span class="string">"LF"</span>,</span><br><span class="line">                   lbMotorName: String = <span class="string">"LB"</span>,</span><br><span class="line">                   rfMotorName: String = <span class="string">"RF"</span>,</span><br><span class="line">                   rbMotorName: String = <span class="string">"RB"</span></span><br><span class="line">) : Omnidirectinal(arrayOf(</span><br><span class="line">    lfMotorName to lfMotorDirection, lbMotorName to lbMotorDirection,</span><br><span class="line">    rfMotorName to rfMotorDirection, rbMotorName to rbMotorDirection), enable) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> Descartes.<span class="title">transform</span><span class="params">()</span></span> =</span><br><span class="line">        doubleArrayOf(</span><br><span class="line">            +x + y - w,</span><br><span class="line">            +x - y - w,</span><br><span class="line">            +x - y + w,</span><br><span class="line">            +x + y + w)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Consequently, there is no need for you to write duplicated code anymore.</p>
<h3 id="Robot"><a href="#Robot" class="headerlink" title="Robot"></a>Robot</h3><p>Structure tree is the core of this library, every node of which is a structure. The foregoing implies that all devices have become <em>monomeric structure</em> which don’t have substructures. Robot is the root of this tree, middleware structures we defined are leaves  under the robot, devices are at the lowest nodes. Therefore, parent nodes just need to manage theirs sons, call <code>run()</code> of them. Because of the transitivity, robot is the parent of all structures.  Lets see an example:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DummyRobot</span> : <span class="type">Robot</span></span>(</span><br><span class="line">    <span class="string">"dummyRobot"</span>,</span><br><span class="line">    Mecanum(enable = <span class="literal">true</span>),</span><br><span class="line">    DummyArm(),</span><br><span class="line">    DeviceFactory.colorSensor(<span class="string">"colorSensor"</span>) &#123;</span><br><span class="line">        enable = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> colorSensor: ColorSensor</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> voltageSensor: VoltageSensor</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject(<span class="meta-string">"mecanumChassis"</span>)</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> chassis: Mecanum</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> dummyArm: DummyArm</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> armState: DummyArm.ArmState = DummyArm.ArmState.DOWN</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">        dummyArm.armState = armState</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Substructures’ instantiation are provided via the constructor of  Robot, and are used through <code>Inject</code>. You may think that it’s redundant that constructing a structure on your own but which can’t be a member of parent structure. In this case, substructures are created by your self, however, you can’t manage the life cycle of a structure frequently.</p>
<h3 id="Op-Mode"><a href="#Op-Mode" class="headerlink" title="Op Mode"></a>Op Mode</h3><p>Op mode is the entry point of whole robot control program. All thins we can do are based on op mode, and it has a <code>hardwareMap</code> providing us a easy why to control device interfaces.  Since we have our robot, we can write our op mode. Devices are bind to theirs corresponding structure wrappers in <code>init</code>, robot’s <code>run()</code> is called in <code>loop</code>. We do something quite import, so we ban the overriding of life cycle call back functions and provide new methods to let user to override:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseOpMode</span>&lt;<span class="type">T : Robot</span>&gt; : <span class="type">OpModeWithRobot</span>&lt;<span class="type">T</span>&gt;</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">val</span> robot: T = createRobot()</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">initTask</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">initLoopTask</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">startTask</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">loopTask</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">stopTask</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Notice at <code>robot</code>, <code>BaseOpMode</code> have a generic parameter <code>T:Robot</code>, which means robot instance can be constructed through its type. However, we have to ensure that robot class can’t be <code>abstract</code> and muse have a public constructor without parameters.</p>
<h3 id="Gamepad"><a href="#Gamepad" class="headerlink" title="Gamepad"></a>Gamepad</h3><p>Let’s see the definition in robot core:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Gamepad</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> left_stick_x = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> left_stick_y = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> right_stick_x = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> right_stick_y = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> dpad_up = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> dpad_down = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> dpad_left = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> dpad_right = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> a = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> b = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> x = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> y = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> start = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> back = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> left_bumper = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> right_bumper = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> left_stick_button = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> right_stick_button = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> left_trigger = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> right_trigger = <span class="number">0f</span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FIRST provides a convenient way to let us use gamepad directly, however, there are some little problems:</p>
<ul>
<li><p>Buttons and joysticks lie in one class flatly, <code>float</code> and <code>double</code> members mix together.</p>
</li>
<li><p>Joysticks have reversed vertical axis.</p>
</li>
<li><p>The way to realize pressing a button only one time (even keep pressing) to execute some actions  one time (e.g. when user press <code>x</code> button, a motor should start to run, etc.) really make people confused.</p>
</li>
</ul>
<p>Thus, we create few classes to reach better encapsulation.</p>
<h4 id="Button"><a href="#Button" class="headerlink" title="Button"></a>Button</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Button</span> : <span class="type">IGamePadComponent</span>&lt;<span class="type">Boolean</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> last = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">bePressed</span><span class="params">()</span></span> = raw</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">isPressing</span><span class="params">()</span></span> = !last &amp;&amp; bePressed()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">isReleasing</span><span class="params">()</span></span> = last &amp;&amp; !bePressed()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> raw: <span class="built_in">Boolean</span> = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            last = field</span><br><span class="line">            field = value</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As you see, <code>bePressed()</code> returns the current state of the button, while you keep pressing, <code>isPressing()</code> returns true only one time, <code>isReleasing()</code> returns true when you stop pressing.</p>
<h4 id="Stick"><a href="#Stick" class="headerlink" title="Stick"></a>Stick</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stick</span> : <span class="type">IGamePadComponent</span>&lt;<span class="type">DoubleArray</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> x <span class="keyword">get</span>() = raw[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> y <span class="keyword">get</span>() = raw[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> theta <span class="keyword">get</span>() = Math.atan2(y, x)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> radius <span class="keyword">get</span>() = sqrt(x * x + y * y)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> feel = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> diedArea = .<span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">mapExpression</span><span class="params">(x: <span class="type">Double</span>, f: <span class="type">Double</span>)</span></span> =</span><br><span class="line">        (f / ((<span class="number">1</span> - f) * (x + <span class="number">1</span>) + f) - f) / (f - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">nonlinearMap</span><span class="params">(x: <span class="type">Double</span>, feel: <span class="type">Double</span>, diedArea: <span class="type">Double</span>)</span></span> = <span class="keyword">when</span> &#123;</span><br><span class="line">        Math.abs(x) &lt; diedArea -&gt; .<span class="number">0</span></span><br><span class="line">        feel == <span class="number">1.0</span>            -&gt; x</span><br><span class="line">        x &lt; <span class="number">0</span>                  -&gt; mapExpression(x, feel)</span><br><span class="line">        <span class="keyword">else</span>                   -&gt; -mapExpression(-x, feel)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> raw: DoubleArray = doubleArrayOf(.<span class="number">0</span>, .<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            field = doubleArrayOf(</span><br><span class="line">                nonlinearMap(value[<span class="number">0</span>], feel, diedArea),</span><br><span class="line">                nonlinearMap(-value[<span class="number">1</span>], feel, diedArea))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We provides a <em>feel</em> represents tactile coefficient, hence, the stick data will be more smooth. Besides, we reversed back y axis.</p>
<h4 id="Trigger"><a href="#Trigger" class="headerlink" title="Trigger"></a>Trigger</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pressingThreshold = <span class="number">0.7</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">var</span> last = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">fun</span> <span class="title">bePressed</span><span class="params">()</span></span> = raw &gt; pressingThreshold</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">fun</span> <span class="title">isPressing</span><span class="params">()</span></span> = !last &amp;&amp; bePressed()</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">fun</span> <span class="title">isReleasing</span><span class="params">()</span></span> = last &amp;&amp; !bePressed()</span><br><span class="line"></span><br><span class="line"> <span class="keyword">override</span> <span class="keyword">var</span> raw: <span class="built_in">Double</span> = .<span class="number">0</span></span><br><span class="line">     <span class="keyword">set</span>(value) &#123;</span><br><span class="line">         last = field &gt; pressingThreshold</span><br><span class="line">         field = value</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>Usually, triggers are used as button is very common, so we add a <code>pressingThreshold</code> to make it become to a button.</p>
<h4 id="Overall"><a href="#Overall" class="headerlink" title="Overall"></a>Overall</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Gamepad</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> leftBumper = Button()</span><br><span class="line">    <span class="keyword">val</span> rightBumper = Button()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> a = Button()</span><br><span class="line">    <span class="keyword">val</span> b = Button()</span><br><span class="line">    <span class="keyword">val</span> x = Button()</span><br><span class="line">    <span class="keyword">val</span> y = Button()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> up = Button()</span><br><span class="line">    <span class="keyword">val</span> down = Button()</span><br><span class="line">    <span class="keyword">val</span> left = Button()</span><br><span class="line">    <span class="keyword">val</span> right = Button()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">val</span> leftStick = Stick()</span><br><span class="line">    <span class="keyword">val</span> rightStick = Stick()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> leftTrigger = Trigger()</span><br><span class="line">    <span class="keyword">val</span> rightTrigger = Trigger()</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h2><p>Let’s see a part of our robot:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dustpan</span> : <span class="type">AbstractStructure</span></span>(</span><br><span class="line">    <span class="string">"dustpan"</span>, &#123;</span><br><span class="line">    servo(<span class="string">"servo"</span>) &#123;</span><br><span class="line">        origin = .<span class="number">0</span></span><br><span class="line">        ending = PI</span><br><span class="line">        enable = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;), Resettable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> servo: Servo</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Volatile</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> isBusy = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> state: State <span class="keyword">by</span> Delegates.observable(State.Down) &#123; _, _, value -&gt;</span><br><span class="line">        servo.position = <span class="keyword">when</span> (value) &#123;</span><br><span class="line">            State.Up   -&gt; DUSTPAN_UP_RAD</span><br><span class="line">            State.Down -&gt; DUSTPAN_DOWN_RAD</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">dump</span><span class="params">(times: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isBusy) <span class="keyword">return</span></span><br><span class="line">        isBusy = <span class="literal">true</span></span><br><span class="line">        GlobalScope.launch &#123;</span><br><span class="line">            repeat(times) &#123;</span><br><span class="line">                state = State.Up</span><br><span class="line">                delay(DUSTPAN_RUNNING_DELAY)</span><br><span class="line">                state = State.Down</span><br><span class="line">                delay(DUSTPAN_RUNNING_DELAY)</span><br><span class="line">            &#125;</span><br><span class="line">            isBusy = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">        Up, Down</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">reset</span><span class="params">()</span></span> &#123;</span><br><span class="line">        state = State.Down</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span>: String = <span class="string">"<span class="subst">$&#123;javaClass.simpleName&#125;</span> | State: <span class="variable">$state</span>"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It is called <code>Dustpan</code>, which is driven by a 180° servo. According the design of library, dustpan is a structure, having device servo as its substructure. Then we abstract two state of this part — <code>Up</code> and <code>Down</code>, which represent two position of servo. For easy to modify parameters and reduce coupling, <code>DUSTPAN_UP_RAD</code> and <code>DUSTPAN_DOWN_RAD</code> lie in other file. Outside can change the value of variable <code>state</code> to change the real state of this robot part.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnicornRobot</span> : <span class="type">Robot</span></span>(</span><br><span class="line">    <span class="string">"unicorn_robot"</span>,</span><br><span class="line">    ...</span><br><span class="line">    Dustpan(),</span><br><span class="line">    ...</span><br><span class="line">) &#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> dustpan: Dustpan</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We have to add it as substructure of robot mentioned before. Since then, we can write a teleop to control it:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnicornRemote</span> : <span class="type">RemoteControlOpMode</span>&lt;<span class="type">UnicornRobot</span>&gt;</span>() &#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">loop</span><span class="params">(master: <span class="type">Gamepad</span>, helper: <span class="type">Gamepad</span>)</span></span>&#123;</span><br><span class="line">    	<span class="comment">//Master</span></span><br><span class="line">    	 <span class="keyword">if</span> (helper.y.isPressing()) </span><br><span class="line">         	robot.dustpan.dump(<span class="number">1</span>)</span><br><span class="line">         <span class="keyword">when</span> &#123;</span><br><span class="line">         	master.y.bePressed() -&gt; robot.dustpan.state=State.Up</span><br><span class="line">         	master.b.bePressed() -&gt; robot.dustpan.state=State.Down</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

	
			
  	</div>
	  
		
	
		<div class="art-item-footer">
				
					<span class="art-item-left"><i class="icon icon-chevron-thin-left"></i>prev：<a href="/Documentation/dependency/" rel="prev" title="Dependency">
						Dependency 
					</a></span>
				
				
					<span class="art-item-right">next：<a href="/Documentation/slf4j-robotLog/" rel="next" title="Slf4j-RobotLog">
						Slf4j-RobotLog
					</a><i class="icon icon-chevron-thin-right"></i></span>
				
		</div>
	
	</section>
	
</article>
<script>
	window.subData = {
		title: 'MechDancer Lib',
		tools: true
	}
</script>

      </div>
      <aside class='l_side'>
        
  <section class="m_widget about">

<img class="avatar waves-image" src="https://github.com/MechDancer/mechdancer.github.io/blob/master/css/images/mechdancer2.png?raw=true">

<div class="header">MechDancer</div>
<div class="content">
<div class="desc">The documentation of MechDancer Projects.</div>
</div>
</section>


  <section class="m_widget links">
<div class="header">Links</div>
<div class="content">
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="https://www.mechdancer.org">
            <div class="name">MechDancer Home</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="https://github.com/berberman">
            <div class="name">berberman Github</div>
        </a></li>
    
    </ul>
</div>
</section>

      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/mechdancer" class="social github" target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href="https://github.com/stkevintan/hexo-theme-material-flow" class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/node-waves/0.7.5/waves.min.js"></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/Documentation/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/Documentation/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/Documentation/js/search.js"></script>
<script src="/Documentation/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
